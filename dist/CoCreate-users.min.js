/* CoCreateJS */
var permissionClass="checkPermission",usersCollection="users",redirectClass="redirectLink";checkSession(),initSocketsForUsers(),fetchUser(),initLoginForms(),initCurrentOrgEles(),initLogoutBtn();var getOrg=!1,updatedCurrentOrg=!1;function initSocketsForUsers(){CoCreateSocket.listen("fetchedUser",function(e){fetchedUser(e)}),CoCreateSocket.listen("login",function(e){loginResult(e)}),CoCreateSocket.listen("createDocument",function(e){registerResult(e)}),CoCreateSocket.listen("usersCurrentOrg",function(e){console.log(e),updatedCurrentOrg=!0,getOrg=!0,localStorage.setItem("apiKey",e.apiKey),localStorage.setItem("securityKey",e.securityKey),localStorage.setItem("organization_id",e.current_org),localStorage.setItem("adminUI_id",e.adminUI_id),localStorage.setItem("builderUI_id",e.builderUI_id)})}function fetchUser(){var e=localStorage.getItem("user_id");if(e){var t={apiKey:config.apiKey,securityKey:config.securityKey,organization_id:config.organization_Id,"data-collection":usersCollection,user_id:e};CoCreateSocket.send("fetchUser",t)}}function fetchedUser(e){console.log(e),checkPermissions(e)}function checkPermissions(e){var t=document.querySelectorAll("."+permissionClass);console.log(t);for(var o=0;o<t.length;o++){var r=t[o],i=r.getAttribute("data-document_id")?r.getAttribute("data-document_id"):r.getAttribute("data-pass_document_id"),n=r.getAttribute("data-permission"),c=e["permission-"+i];if(console.log(c),-1==c.indexOf(n))switch(n){case"create":case"read":case"delete":r.style.display="none";break;case"delete":r.readOnly=!0}else n}}function initLoginForms(){for(var e=document.querySelectorAll("form"),t=0;t<e.length;t++)isLoginForm(e[t])&&initLoginForm(e[t])}function initLoginForm(e){console.log(e);var t=e.getAttribute("data-form_id");e.querySelector(".loginBtn").addEventListener("click",function(o){o.preventDefault(),console.log(this);var r=e.getAttribute("data-search_collection")?e.getAttribute("data-search_collection"):"module_activity",i=e.getAttribute("data-search_module");console.log(r,i);var n=new Object,c=e.querySelectorAll("input, textarea");console.log(c);for(var l=0;l<c.length;l++){var a=c[l],s=a.getAttribute("name"),u=a.value;"password"==a.type&&(u=CoCreateUtils.encodeBase64(u)),s&&(n[s]=u)}var g={apiKey:config.apiKey,securityKey:config.securityKey,organization_id:config.organization_Id,eId:t,"data-collection":r,loginData:n};"module_activity"==r&&(g["data-module"]=i),console.log(g),CoCreateSocket.send("login",g)})}function loginResult(e){if(e.success){localStorage.setItem("user_id",e.id),getCurrentOrg(e.id);var t=e.eId,o=setInterval(function(){if(getOrg){var e=document.querySelector("form[data-form_id='"+t+"']");if(e){var r=e.querySelector(".loginBtn");if(r){var i=r.querySelector("a");i&&(CoCreateLogic.setLinkProcess(i),clearInterval(o))}}}},100)}else console.log("can't login")}function getCurrentOrg(e){var t={"data-collection":"users",user_id:e};CoCreateSocket.send("usersCurrentOrg",t)}function isLoginForm(e){return!!e.querySelector(".loginBtn")}function registerResult(e){var t=e.element;const o=e.document_id;var r=document.querySelector("form[data-form_id='"+t+"']");if(r&&isRegisterForm(r)){localStorage.setItem("user_id",o);var i=r.querySelector(".registerBtn");if(i){var n=i.querySelector("a");n&&(n.setAttribute("data-pass_document_id",o),CoCreateLogic.setLinkProcess(n))}}}function isRegisterForm(e){return!!e.querySelector(".registerBtn")}function initCurrentOrgEles(){var e=localStorage.getItem("user_id");if(!e)return;let t=document.querySelectorAll(".org-changer");for(let i=0;i<t.length;i++){let n=t[i];var o=n.getAttribute("data-collection")?n.getAttribute("data-collection"):"module_activity",r=n.getAttribute("data-document_id");"users"==o&&r==e&&n.addEventListener("selectedValue",function(t){console.log(CoCreateSelect.getSelectValue(this)),setTimeout(function(){getCurrentOrg(e);var t=setInterval(function(){updatedCurrentOrg&&(location.reload(),clearInterval(t))},100)},300)})}}function initLogoutBtn(){let e=document.querySelectorAll(".logoutBtn");for(let t=0;t<e.length;t++){e[t].addEventListener("click",function(e){e.preventDefault(),localStorage.clear();let t=this.getAttribute("href");t&&(document.location.href=t)})}}function checkSession(){var e;if(localStorage.getItem("user_id")){if(console.log(1),e=document.querySelector(".sessionTrue")){console.log(2);let t=e.getAttribute("href");t&&(console.log(3),document.location.href=t)}}else if(console.log(4),e=document.querySelector(".sessionFalse")){console.log(5);let t=e.getAttribute("href");t&&(console.log(6),localStorage.clear(),document.location.href=t)}}